<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<div id="show" >
</div>










  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Zero, Welcom!" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="走过山山水水,脚下高高低低,人生难得糊涂！">
<meta property="og:type" content="website">
<meta property="og:title" content="Zero">
<meta property="og:url" content="http://yoursite.com/page/13/index.html">
<meta property="og:site_name" content="Zero">
<meta property="og:description" content="走过山山水水,脚下高高低低,人生难得糊涂！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zero">
<meta name="twitter:description" content="走过山山水水,脚下高高低低,人生难得糊涂！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/13/"/>





  <title> Zero </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Zero</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/22/redis3-2-0配置文件详解/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/22/redis3-2-0配置文件详解/" itemprop="url">
                  redis3.2.0配置文件详解（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Дата создания записи" itemprop="dateCreated datePublished" datetime="2016-12-22T16:54:11+08:00">
                2016-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/22/redis3-2-0配置文件详解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/22/redis3-2-0配置文件详解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/22/redis3-2-0配置文件详解/" class="leancloud_visitors" data-flag-title="redis3.2.0配置文件详解（二）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装步骤："><a href="#安装步骤：" class="headerlink" title="安装步骤："></a>安装步骤：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@ucloud-pro-bj2D-renmai-redis01 redis]# cat install.sls </div><div class="line">redis-source-install:</div><div class="line">  - source: salt://redis/files/redis-3.2.0.tar.gz</div><div class="line">  - name: /usr/local/src/redis-3.2.0.tar.gz</div><div class="line">  - user: root</div><div class="line">  - group: root</div><div class="line">  - mode: 644</div><div class="line">  cmd.run:</div><div class="line">  - name: cd /usr/local/src &amp;&amp;  tar -xzvf redis-3.2.0.tar.gz -C /usr/local/redis-3.2.0 &amp;&amp; cd /usr/local/redis-3.2.0  &amp;&amp; make &amp;&amp; make install </div><div class="line">  - require:</div><div class="line">    - file: redis-source-install</div><div class="line">  - unless: test -d  /usr/local/redis-3.2.0</div><div class="line">``` </div><div class="line">  </div><div class="line">#### 基础配置选项</div></pre></td></tr></table></figure>
<p>#指定 redis 只接收来自于该 IP 地址的请求，如果不进行设置，那么将处理所有请求<br>bind  10.19.42.33</p>
<p>#3.2里的参数，是否开启保护模式，默认开启。要是配置里没有指定bind和密码。<br>开启该参数后，redis只会本地进行访问，拒绝外部访问。要是开启了密码和bind，可以开启。否则最好关闭，设置为no。<br>protected-mode yes</p>
<p>#redis监听的端口号。<br>port 6379</p>
<p>#此参数确定了TCP连接中已完成队列(完成三次握手之后)的长度， 当然此值必须不大于Linux系统定义的</p>
<p>#/proc/sys/net/core/somaxconn值，默认是511，而Linux的默认参数值是128。当系统并发量大并且客户端速度缓慢的时候，可以将这二个参数一起参考设定。该内核参数默认值一般是128，对于负载很大的服务程序来说大大的不够。一般会将它修改为2048或者更大。在/etc/sysctl.conf中添加:net.core.somaxconn = 2048，然后在终端中执行sysctl -p。<br>tcp-backlog 511</p>
<p>#此参数为设置客户端空闲超过timeout，服务端会断开连接，为0则服务端不会主动断开连接，不能小于0<br>timeout 0</p>
<p>#tcp keepalive参数。如果设置不为0，就使用配置tcp的SO_KEEPALIVE值，</p>
<p>#使用keepalive有两个好处:检测挂掉的对端。降低中间设备出问题而导致网络看似连接却已经与对端端口的问题。</p>
<p>#在Linux内核中，设置了keepalive，redis会定时给对端发送ack。检测到对端关闭需要两倍的设置值。<br>tcp-keepalive 0</p>
<p>#是否在后台执行，yes：后台运行；no：不是后台运行（老版本默认）<br>daemonize yes</p>
<p>#用supervised来管理，默认是no<br>supervised no</p>
<p>#pid文件<br>pidfile /var/run/redis.pid</p>
<p>#指定了服务端日志的级别。级别包括：debug（很多信息，方便开发、测试），verbose</p>
<p>#（许多有用的信息，但是没有debug级别信息多），notice（适当的日志级别，适合生产环境），warn（只有非常重要的信息）<br>loglevel notice</p>
<p>#指定了记录日志的文件。空字符串的话，日志会打印到标准输出设备。后台运行的redis标准输出是/dev/null。<br>logfile “/var/log/redis/redis.log”</p>
<p>#数据库的数量，默认使用的数据库是DB 0。可以通过”SELECT “命令选择一个db<br>databases 16<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 快照配置：</div></pre></td></tr></table></figure></p>
<p>################################ SNAPSHOTTING ################################</p>
<h1 id="快照配置"><a href="#快照配置" class="headerlink" title="快照配置"></a>快照配置</h1><h1 id="注释掉“save”这一行配置项就可以让保存数据库功能失效"><a href="#注释掉“save”这一行配置项就可以让保存数据库功能失效" class="headerlink" title="注释掉“save”这一行配置项就可以让保存数据库功能失效"></a>注释掉“save”这一行配置项就可以让保存数据库功能失效</h1><h1 id="设置sedis进行数据库镜像的频率。"><a href="#设置sedis进行数据库镜像的频率。" class="headerlink" title="设置sedis进行数据库镜像的频率。"></a>设置sedis进行数据库镜像的频率。</h1><h1 id="900秒（15分钟）内至少1个key值改变（则进行数据库保存–持久化）"><a href="#900秒（15分钟）内至少1个key值改变（则进行数据库保存–持久化）" class="headerlink" title="900秒（15分钟）内至少1个key值改变（则进行数据库保存–持久化）"></a>900秒（15分钟）内至少1个key值改变（则进行数据库保存–持久化）</h1><h1 id="300秒（5分钟）内至少10个key值改变（则进行数据库保存–持久化）"><a href="#300秒（5分钟）内至少10个key值改变（则进行数据库保存–持久化）" class="headerlink" title="300秒（5分钟）内至少10个key值改变（则进行数据库保存–持久化）"></a>300秒（5分钟）内至少10个key值改变（则进行数据库保存–持久化）</h1><h1 id="60秒（1分钟）内至少10000个key值改变（则进行数据库保存–持久化）"><a href="#60秒（1分钟）内至少10000个key值改变（则进行数据库保存–持久化）" class="headerlink" title="60秒（1分钟）内至少10000个key值改变（则进行数据库保存–持久化）"></a>60秒（1分钟）内至少10000个key值改变（则进行数据库保存–持久化）</h1><p>save 900 1<br>save 300 10<br>save 60 10000</p>
<p>#当RDB持久化出现错误后，是否依然进行继续进行工作，yes：不能进行工作，no：可以继续进行工作，可</p>
<p>#以通过info中的rdb_last_bgsave_status了解RDB持久化是否有错误<br>stop-writes-on-bgsave-error yes</p>
<p>#使用压缩rdb文件，rdb文件压缩使用LZF压缩算法，yes：压缩，但是需要一些cpu的消耗。no：不压缩，需要更多的磁盘空间<br>rdbcompression yes</p>
<p>#是否校验rdb文件。从rdb格式的第五个版本开始，在rdb文件的末尾会带上CRC64的校验和。</p>
<p>#这跟有利于文件的容错性，但是在保存rdb文件的时候，会有大概10%的性能损耗，所以如果你追求高性能，可以关闭该配置。<br>rdbchecksum yes</p>
<p>#rdb文件的名称<br>dbfilename dump.rdb</p>
<p>#数据目录，数据库的写入会在这个目录。rdb、aof文件也会写在这个目录<br>dir ./</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 主从配置选项</div></pre></td></tr></table></figure>
<p>#master不需要开启</p>
<h3 id="未开启选项"><a href="#未开启选项" class="headerlink" title="未开启选项"></a>未开启选项</h3><p>################################# REPLICATION #################################</p>
<p>#复制选项，slave复制对应的master。</p>
<h1 id="slaveof"><a href="#slaveof" class="headerlink" title="slaveof  "></a>slaveof <masterip> <masterport></masterport></masterip></h1><p>#如果master设置了requirepass，那么slave要连上master，需要有master的密码才行。masterauth就是用来配置master的密码，这样可以在连上master后进行认证。<br>masterauth <master-password><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 其它选项</div></pre></td></tr></table></figure></master-password></p>
<p>#当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：1) 如果slave-serve-stale-data设置为yes(默认设置)，</p>
<p>#从库会继续响应客户端的请求。2) 如果slave-serve-stale-data设置为no，除去INFO和SLAVOF命令之外的任何请求都会返回一个错误”SYNC with master in progress”。<br>slave-serve-stale-data yes</p>
<p>#作为从服务器，默认情况下是只读的（yes），可以修改成NO，用于写（不建议）。<br>slave-read-only yes</p>
<h3 id="已经开启选项"><a href="#已经开启选项" class="headerlink" title="已经开启选项"></a>已经开启选项</h3><p>#是否使用socket方式复制数据。目前redis复制提供两种方式，disk和socket。如果新的slave连上来或者重连的slave无法部分同步，就会执行全量同步，</p>
<p>#master会生成rdb文件。有2种方式：disk方式是master创建一个新的进程把rdb文件保存到磁盘，再把磁盘上的rdb文件传递给slave。</p>
<p>#socket是master创建一个新的进程，直接把rdb文件以socket的方式发给slave。disk方式的时候，当一个rdb保存的过程中，</p>
<p>#多个slave都能共享这个rdb文件。socket的方式就的一个个slave顺序复制。在磁盘速度缓慢，网速快的情况下推荐用socket方式。<br>repl-diskless-sync no</p>
<p>#diskless复制的延迟时间，防止设置为0。一旦复制开始，节点不会再接收新slave的复制请求直到下一个rdb传输。</p>
<p>#所以最好等待一段时间，等更多的slave连上来。<br>repl-diskless-sync-delay 5</p>
<p>#slave根据指定的时间间隔向服务器发送ping请求。时间间隔可以通过 repl_ping_slave_period 来设置，默认10秒。</p>
<h1 id="repl-ping-slave-period-10"><a href="#repl-ping-slave-period-10" class="headerlink" title="repl-ping-slave-period 10"></a>repl-ping-slave-period 10</h1><p>#复制连接超时时间。master和slave都有超时时间的设置。master检测到slave上次发送的时间超过repl-timeout，即认为slave离线，</p>
<p>#清除该slave信息。slave检测到上次和master交互的时间超过repl-timeout，则认为master离线。需要注意的是repl-timeout需要设</p>
<p>#置一个比repl-ping-slave-period更大的值，不然会经常检测到超时。</p>
<h1 id="repl-timeout-60"><a href="#repl-timeout-60" class="headerlink" title="repl-timeout 60"></a>repl-timeout 60</h1><p>#是否禁止复制tcp链接的tcp nodelay参数，可传递yes或者no。默认是no，即使用tcp nodelay。如果master设置了yes来禁止tcp nodelay设置，</p>
<p>#在把数据复制给slave的时候，会减少包的数量和更小的网络带宽。但是这也可能带来数据的延迟。默认我们推荐更小的延迟，</p>
<p>#但是在数据量传输很大的场景下，建议选择yes。</p>
<p>repl-disable-tcp-nodelay no</p>
<p>#当master不可用，Sentinel会根据slave的优先级选举一个master。最低的优先级的slave，当选master。而配置成0，永远不会被选举。<br>slave-priority 100</p>
<p>#redis提供了可以让master停止写入的方式，如果配置了min-slaves-to-write，</p>
<p>#健康的slave的个数小于N，master就禁止写入。master最少得有多少个健康的slave存活才能执行写命令。</p>
<p>#这个配置虽然不能保证N个slave都一定能接收到master的写操作，但是能避免没有足够健康的slave的时候，master不能写入来避免数据丢失。设置为0是关闭该功能。</p>
<p>#min-slaves-to-write 3</p>
<p>#延迟小于min-slaves-max-lag秒的slave才认为是健康的slave。<br>min-slaves-max-lag 10</p>
<h1 id="设置1或另一个设置为0禁用这个特性。"><a href="#设置1或另一个设置为0禁用这个特性。" class="headerlink" title="设置1或另一个设置为0禁用这个特性。"></a>设置1或另一个设置为0禁用这个特性。</h1><h1 id="Setting-one-or-the-other-to-0-disables-the-feature"><a href="#Setting-one-or-the-other-to-0-disables-the-feature" class="headerlink" title="Setting one or the other to 0 disables the feature."></a>Setting one or the other to 0 disables the feature.</h1><h1 id="By-default-min-slaves-to-write-is-set-to-0-feature-disabled-and"><a href="#By-default-min-slaves-to-write-is-set-to-0-feature-disabled-and" class="headerlink" title="By default min-slaves-to-write is set to 0 (feature disabled) and"></a>By default min-slaves-to-write is set to 0 (feature disabled) and</h1><h1 id="min-slaves-max-lag-is-set-to-10"><a href="#min-slaves-max-lag-is-set-to-10" class="headerlink" title="min-slaves-max-lag is set to 10."></a>min-slaves-max-lag is set to 10.</h1><p>#requirepass配置可以让用户使用AUTH命令来认证密码，才能使用其他命令。这让redis可以使用在不受信任的网络中。</p>
<p>#为了保持向后的兼容性，可以注释该命令，因为大部分用户也不需要认证。使用requirepass的时候需要注意，因为redis太快了，</p>
<p>#每秒可以认证15w次密码，简单的密码很容易被攻破，所以最好使用一个更复杂的密码。<br>requirepass foobared</p>
<p>#把危险的命令给修改成其他名称。比如CONFIG命令可以重命名为一个很难被猜到的命令，这样用户不能使用，而内部工具还能接着使用。</p>
<h1 id="rename-command-CONFIG-b840fc02d524045429941cc15f59e41cb7be6c52"><a href="#rename-command-CONFIG-b840fc02d524045429941cc15f59e41cb7be6c52" class="headerlink" title="rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52"></a>rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</h1><h4 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h4><h1 id="设置能连上redis的最大客户端连接数量。默认是10000个客户端连接。由于redis不区分连接是客户端连接还是内部打开文件或者和slave连接等，"><a href="#设置能连上redis的最大客户端连接数量。默认是10000个客户端连接。由于redis不区分连接是客户端连接还是内部打开文件或者和slave连接等，" class="headerlink" title="设置能连上redis的最大客户端连接数量。默认是10000个客户端连接。由于redis不区分连接是客户端连接还是内部打开文件或者和slave连接等，"></a>设置能连上redis的最大客户端连接数量。默认是10000个客户端连接。由于redis不区分连接是客户端连接还是内部打开文件或者和slave连接等，</h1><p>#所以maxclients最小建议设置到32。如果超过了maxclients，redis会给新的连接发送’max number of clients reached’，并关闭连接。</p>
<h1 id="maxclients-10000"><a href="#maxclients-10000" class="headerlink" title="maxclients 10000"></a>maxclients 10000</h1><h3 id="内存配置"><a href="#内存配置" class="headerlink" title="内存配置"></a>内存配置</h3><p>#redis配置的最大内存容量。当内存满了，需要配合maxmemory-policy策略进行处理。注意slave的输出缓冲区是不计算在maxmemory内的。所以为了防止主机内存使用完，建议设置的maxmemory需要更小一些。</p>
<h1 id="maxmemory"><a href="#maxmemory" class="headerlink" title="maxmemory "></a>maxmemory <bytes></bytes></h1><p>#内存容量超过maxmemory后的处理策略。</p>
<p>#volatile-lru：利用LRU算法移除设置过过期时间的key。</p>
<p>#volatile-random：随机移除设置过过期时间的key。</p>
<p>#volatile-ttl：移除即将过期的key，根据最近过期时间来删除（辅以TTL）</p>
<p>#allkeys-lru：利用LRU算法移除任何key。</p>
<p>#allkeys-random：随机移除任何key。</p>
<p>#noeviction：不移除任何key，只是返回一个写错误。</p>
<p>#上面的这些驱逐策略，如果redis没有合适的key驱逐，对于写命令，还是会返回错误。redis将不再接收写请求，只接收get请求。写命令包括：set setnx setex append incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby getset mset msetnx exec sort。</p>
<h1 id="maxmemory-policy-noeviction"><a href="#maxmemory-policy-noeviction" class="headerlink" title="maxmemory-policy noeviction"></a>maxmemory-policy noeviction</h1><p>#lru检测的样本数。使用lru或者ttl淘汰算法，从需要淘汰的列表中随机选择sample个key，选出闲置时间最长的key移除。</p>
<h1 id="maxmemory-samples-5"><a href="#maxmemory-samples-5" class="headerlink" title="maxmemory-samples 5"></a>maxmemory-samples 5</h1><h5 id="APPEND-ONLY-MODE"><a href="#APPEND-ONLY-MODE" class="headerlink" title="APPEND ONLY MODE"></a>APPEND ONLY MODE</h5><p>#默认redis使用的是rdb方式持久化，这种方式在许多应用中已经足够用了。但是redis如果中途宕机，</p>
<p>#会导致可能有几分钟的数据丢失，根据save来策略进行持久化，Append Only File是另一种持久化方式，可以提供更好的持久化特性。</p>
<p>#Redis会把每次写入的数据在接收后都写入 appendonly.aof 文件，每次启动时Redis都会先把这个文件的数据读入内存里，先忽略RDB文件。<br>appendonly yes<br>appendfilename “appendonly.aof”</p>
<p>#aof持久化策略的配置</p>
<p>#no表示不执行fsync，由操作系统保证数据同步到磁盘，速度最快。</p>
<p>#always表示每次写入都执行fsync，以保证数据同步到磁盘。</p>
<p>#everysec表示每秒执行一次fsync，可能会导致丢失这1s数据。<br>appendfsync everysec</p>
<p>#在aof重写或者写入rdb文件的时候，会执行大量IO，此时对于everysec和always的aof模式来说，执行fsync会造成阻塞过长时间，</p>
<p>#no-appendfsync-on-rewrite字段设置为默认设置为no。如果对延迟要求很高的应用，这个字段可以设置为yes，</p>
<p>#否则还是设置为no，这样对持久化特性来说这是更安全的选择。设置为yes表示rewrite期间对新写操作不fsync,暂时存在内存中,等rewrite完成后再写入，默认为no，</p>
<p>#建议yes。Linux的默认fsync策略是30秒。可能丢失30秒数据。<br>no-appendfsync-on-rewrite no</p>
<p>auto-aof-rewrite-percentage 100</p>
<p>#设置允许重写的最小aof文件大小，避免了达到约定百分比但尺寸仍然很小的情况还要重写<br>auto-aof-rewrite-min-size 64mb</p>
<p>#aof文件可能在尾部是不完整的，当redis启动的时候，aof文件的数据被载入内存。</p>
<p>#重启可能发生在redis所在的主机操作系统宕机后，尤其在ext4文件系统没有加上data=ordered选项（redis宕机或者异常终止不会造成尾部不完整现象。）出现这种现象，</p>
<p>#可以选择让redis退出，或者导入尽可能多的数据。如果选择的是yes，当截断的aof文件被导入的时候，会自动发布一个log给客户端然后load。</p>
<p>#如果是no，用户必须手动redis-check-aof修复AOF文件才可以。<br>aof-load-truncated yes</p>
<h4 id="LUA-SCRIPTING"><a href="#LUA-SCRIPTING" class="headerlink" title="LUA SCRIPTING"></a>LUA SCRIPTING</h4><p>#如果达到最大时间限制（毫秒），redis会记个log，然后返回error。当一个脚本超过了最大时限。</p>
<p>#只有SCRIPT KILL和SHUTDOWN NOSAVE可以用。第一个可以杀没有调write命令的东西。要是已经调用了write，只能用第二个命令杀。<br>lua-time-limit 5000</p>
<p>################################ REDIS CLUSTER ###############################</p>
<p>#集群开关，默认是不开启集群模式。</p>
<h1 id="cluster-enabled-yes"><a href="#cluster-enabled-yes" class="headerlink" title="cluster-enabled yes"></a>cluster-enabled yes</h1><p>#集群配置文件的名称，每个节点都有一个集群相关的配置文件，持久化保存集群的信息。这个文件并不需要手动配置，</p>
<p>#这个配置文件有Redis生成并更新，每个Redis集群节点需要一个单独的配置文件，请确保与实例运行的系统中配置文件名称不冲突</p>
<h1 id="cluster-config-file-nodes-6379-conf"><a href="#cluster-config-file-nodes-6379-conf" class="headerlink" title="cluster-config-file nodes-6379.conf"></a>cluster-config-file nodes-6379.conf</h1><p>#节点互连超时的阀值。集群节点超时毫秒数</p>
<h1 id="cluster-node-timeout-15000"><a href="#cluster-node-timeout-15000" class="headerlink" title="cluster-node-timeout 15000"></a>cluster-node-timeout 15000</h1><p>#在进行故障转移的时候，全部slave都会请求申请为master，但是有些slave可能与master断开连接一段时间了，导致数据过于陈旧，这样的slave不应该被提升为master。</p>
<p>#该参数就是用来判断slave节点与master断线的时间是否过长。判断方法是：</p>
<p>#比较slave断开连接的时间和(node-timeout * slave-validity-factor) + repl-ping-slave-period</p>
<p>#如果节点超时时间为三十秒, 并且slave-validity-factor为10,假设默认的repl-ping-slave-period是10秒，即如果超过310秒slave将不会尝试进行故障转移 </p>
<h1 id="cluster-slave-validity-factor-10"><a href="#cluster-slave-validity-factor-10" class="headerlink" title="cluster-slave-validity-factor 10"></a>cluster-slave-validity-factor 10</h1><p>#master的slave数量大于该值，slave才能迁移到其他孤立master上，如这个参数若被设为2，那么只有当一个主节点拥有2 个可工作的从节点时，它的一个从节点会尝试迁移。</p>
<h1 id="cluster-migration-barrier-1"><a href="#cluster-migration-barrier-1" class="headerlink" title="cluster-migration-barrier 1"></a>cluster-migration-barrier 1</h1><p>#默认情况下，集群全部的slot有节点负责，集群状态才为ok，才能提供服务。设置为no，可以在slot没有全部分配的时候提供服务。</p>
<p>#不建议打开该配置，这样会造成分区的时候，小分区的master一直在接受写请求，而造成很长时间数据不一致。</p>
<h1 id="cluster-require-full-coverage-yes"><a href="#cluster-require-full-coverage-yes" class="headerlink" title="cluster-require-full-coverage yes"></a>cluster-require-full-coverage yes</h1><p>################################## SLOW LOG ###################################</p>
<p>###slog log是用来记录redis运行中执行比较慢的命令耗时。当命令的执行超过了指定时间，就记录在slow log中，slog log保存在内存中，所以没有IO操作。</p>
<p>#执行时间比slowlog-log-slower-than大的请求记录到slowlog里面，单位是微秒，所以1000000就是1秒。注意，负数时间会禁用慢查询日志，而0则会强制记录所有命令。</p>
<p>slowlog-log-slower-than 10000</p>
<p>#慢查询日志长度。当一个新的命令被写进日志的时候，最老的那个记录会被删掉。这个长度没有限制。只要有足够的内存就行。你可以通过 SLOWLOG RESET 来释放内存。<br>slowlog-max-len 128</p>
<p>################################ LATENCY MONITOR ##############################</p>
<p>#延迟监控功能是用来监控redis中执行比较缓慢的一些操作，用LATENCY打印redis实例在跑命令时的耗时图表。只记录大于等于下边设置的值的操作。0的话，就是关闭监视。</p>
<p>#默认延迟监控功能是关闭的，如果你需要打开，也可以通过CONFIG SET命令动态设置。<br>latency-monitor-threshold 0</p>
<p>############################# EVENT NOTIFICATION ##############################</p>
<p>#键空间通知使得客户端可以通过订阅频道或模式，来接收那些以某种方式改动了 Redis 数据集的事件。因为开启键空间通知功能需要消耗一些 CPU ，所以在默认配置下，该功能处于关闭状态。</p>
<p>#notify-keyspace-events 的参数可以是以下字符的任意组合，它指定了服务器该发送哪些类型的通知：</p>
<p>##K 键空间通知，所有通知以 <strong>keyspace@</strong> 为前缀</p>
<p>##E 键事件通知，所有通知以 <strong>keyevent@</strong> 为前缀</p>
<p>##g DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知</p>
<p>##$ 字符串命令的通知</p>
<p>##l 列表命令的通知</p>
<p>##s 集合命令的通知</p>
<p>##h 哈希命令的通知</p>
<p>##z 有序集合命令的通知</p>
<p>##x 过期事件：每当有过期键被删除时发送</p>
<p>##e 驱逐(evict)事件：每当有键因为 maxmemory 政策而被删除时发送</p>
<p>##A 参数 g$lshzxe 的别名</p>
<p>#输入的参数中至少要有一个 K 或者 E，否则的话，不管其余的参数是什么，都不会有任何 通知被分发。详细使用可以参考<a href="http://redis.io/topics/notifications" target="_blank" rel="external">http://redis.io/topics/notifications</a></p>
<p>notify-keyspace-events “”</p>
<p>############################### ADVANCED CONFIG ###############################</p>
<p>#数据量小于等于hash-max-ziplist-entries的用ziplist，大于hash-max-ziplist-entries用hash<br>hash-max-ziplist-entries 512</p>
<p>#value大小小于等于hash-max-ziplist-value的用ziplist，大于hash-max-ziplist-value用hash。<br>hash-max-ziplist-value 64</p>
<p>list-max-ziplist-size -2</p>
<p>list-compress-depth 0<br>set-max-intset-entries 512</p>
<p>#数据量小于等于zset-max-ziplist-entries用ziplist，大于zset-max-ziplist-entries用zset。<br>zset-max-ziplist-entries 128</p>
<p>#数据量小于等于zset-max-ziplist-entries用ziplist，大于zset-max-ziplist-entries用zset。<br>zset-max-ziplist-value 64</p>
<p>#value大小小于等于hll-sparse-max-bytes使用稀疏数据结构（sparse），大于hll-sparse-max-bytes使用稠密的数据结构（dense）。</p>
<p>#一个比16000大的value是几乎没用的，建议的value大概为3000。如果对CPU要求不高，对空间要求较高的，建议设置到10000左右。<br>hll-sparse-max-bytes 3000</p>
<p>#Redis将在每100毫秒时使用1毫秒的CPU时间来对redis的hash表进行重新hash，可以降低内存的使用。当你的使用场景中，有非常严格的实时性需要，</p>
<p>#不能够接受Redis时不时的对请求有2毫秒的延迟的话，把这项配置为no。如果没有这么严格的实时性要求，可以设置为yes，以便能够尽可能快的释放内存。<br>activerehashing yes</p>
<p>##对客户端输出缓冲进行限制可以强迫那些不从服务器读取数据的客户端断开连接，用来强制关闭传输缓慢的客户端。</p>
<p>#对于normal client，第一个0表示取消hard limit，第二个0和第三个0表示取消soft limit，normal client默认取消限制，因为如果没有寻问，他们是不会接收数据的。<br>client-output-buffer-limit normal 0 0 0</p>
<p>#对于slave client和MONITER client，如果client-output-buffer一旦超过256mb，又或者超过64mb持续60秒，那么服务器就会立即断开客户端连接。<br>client-output-buffer-limit slave 256mb 64mb 60</p>
<p>#对于pubsub client，如果client-output-buffer一旦超过32mb，又或者超过8mb持续60秒，那么服务器就会立即断开客户端连接。<br>client-output-buffer-limit pubsub 32mb 8mb 60</p>
<p>hz 10</p>
<p>aof-rewrite-incremental-fsync yes<br>```</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/22/saltstack双主配置/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/22/saltstack双主配置/" itemprop="url">
                  saltstack双主配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Дата создания записи" itemprop="dateCreated datePublished" datetime="2016-12-22T11:18:08+08:00">
                2016-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/22/saltstack双主配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/22/saltstack双主配置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/22/saltstack双主配置/" class="leancloud_visitors" data-flag-title="saltstack双主配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>随着管理的项目越来越大，任何单点故障都是难以忍受的。下面说说saltstack的双主配置及维护。<br>在建立多Master的配置中，主要的一点就是所有的Master使用同样的private key. 这些key将在Master第一次启动时自动生成。 因此在多Master环境建立时，<br>需要从原始的(original) Master上拷贝其private key至第二个Master以提供它启动时自动生成的那个, 以此类推.<br>Master的private key存储在Master本地的 pki_dir 目录下. 默认的目录是 /etc/salt/pki/master/master.pem .<br>将该key拷贝到新增的master上. 需要注意的是，在拷贝的时候，需要确保新增的master上并没有minion连接进来.</p>
<h3 id="配置多master时"><a href="#配置多master时" class="headerlink" title="配置多master时"></a>配置多master时</h3><p>当配置多Master时，Minion需要知道需要连接的每个Master的网络地址. 需要在Minion的配置文件中进行配置，默认的配置文件是 /etc/salt/minion 。<br>找到 master 配置项, 更新需要新增的Master.</p>
<p>下边是一个多Master的配置例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">minion文件配置修改：</div><div class="line">[root@ucloud-pro-bj2D-renmai-redis01 saltclient]# cat files/minion |grep master</div><div class="line">master: </div><div class="line">  - &#123;&#123; master1 &#125;&#125;</div><div class="line">  - &#123;&#123; master2 &#125;&#125;</div><div class="line">  </div><div class="line">pillar配置文件修改：</div><div class="line">[root@ucloud-pro-bj2D-renmai-redis01 saltclient]# cat /srv/pillar/zl/sal.sls </div><div class="line">salt:</div><div class="line">  salt-master1: 10.19.42.33 </div><div class="line">  salt-master2: 10.19.99.195</div><div class="line">  </div><div class="line">minion配置文件修改：</div><div class="line">[root@ucloud-pro-bj2D-renmai-redis01 saltclient]# cat install.sls </div><div class="line">salt-yum-epel:</div><div class="line">  file.managed:</div><div class="line">    - name: /etc/yum.repos.d/salt5.8.repo</div><div class="line">    - source: salt://saltclient/files/salt5.8.repo</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - mode: 644</div><div class="line">salt-rpm-install:</div><div class="line">   pkg.installed:</div><div class="line">    - name: salt-minion</div><div class="line">    - require:</div><div class="line">      - file: salt-yum-epel</div><div class="line">/etc/salt/minion:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://saltclient/files/minion</div><div class="line">    - mode: 640</div><div class="line">    - user: root</div><div class="line">    - template: jinja</div><div class="line">    - defaults:</div><div class="line">      master1: &#123;&#123; pillar[&apos;salt&apos;][&apos;salt-master1&apos;] &#125;&#125;</div><div class="line">      master2: &#123;&#123; pillar[&apos;salt&apos;][&apos;salt-master2&apos;] &#125;&#125;</div><div class="line">      id: &#123;&#123; grains[&apos;fqdn&apos;] &#125;&#125;</div><div class="line">  service:</div><div class="line">    - name: salt-minion</div><div class="line">    - running</div><div class="line">    - enable: True</div><div class="line">    - reload: True</div><div class="line">    - watch:</div><div class="line">      - file: /etc/salt/minion</div></pre></td></tr></table></figure></p>
<p>配置完上面的所有文件之后，下一步要做的就是重启所有minion客户端。<br>验证配置的正确性，我就不出图了，生产上已经在跑着了。</p>
<p>维护注意事项：</p>
<h3 id="那些文件需要维护"><a href="#那些文件需要维护" class="headerlink" title="那些文件需要维护"></a>那些文件需要维护</h3><h4 id="Minion-Keys"><a href="#Minion-Keys" class="headerlink" title="Minion Keys"></a>Minion Keys</h4><p>minion的key需要在每个master进行accept，可以使用salt-key手动接受minion的key，也可以在master之间保持<br>key目录的同步。需要同步的目录有：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/etc/salt/pki/master/minions</div><div class="line">/etc/salt/pki/master/minions_pre</div><div class="line">/etc/salt/pki/master/minions_rejected</div></pre></td></tr></table></figure></p>
<p>注意：直接共享/etc/salt/master目录是强烈反对的，别人拿到的话，将会带来严重的安全风险你懂得，就可以随意控制公司的服务器了。</p>
<h4 id="file-roots"><a href="#file-roots" class="headerlink" title="file_roots"></a>file_roots</h4><p>方法一：git仓库中心，但是这个比较被动，每次都要更新git。<br>方法二：共享存储，将state.sls文件都放到共享存储上。我这里就全部放在glusterfs上了。项目中在用不用白不用呀。</p>
<h3 id="pillar-roots"><a href="#pillar-roots" class="headerlink" title="pillar_roots"></a>pillar_roots</h3><p>同file_roots的同步方法。</p>
<h4 id="salt的主配置文件-etc-salt-master"><a href="#salt的主配置文件-etc-salt-master" class="headerlink" title="salt的主配置文件/etc/salt/master"></a>salt的主配置文件/etc/salt/master</h4><p>这个配置文件你可以放到git仓库里面，也可以建个rsync。</p>
<p>好了就说这么多了，祝好运。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/21/redis基本概念介绍/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/21/redis基本概念介绍/" itemprop="url">
                  redis基本概念介绍(一)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Дата создания записи" itemprop="dateCreated datePublished" datetime="2016-12-21T14:10:18+08:00">
                2016-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/21/redis基本概念介绍/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/21/redis基本概念介绍/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/21/redis基本概念介绍/" class="leancloud_visitors" data-flag-title="redis基本概念介绍(一)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="What’s-Redis"><a href="#What’s-Redis" class="headerlink" title="What’s Redis"></a>What’s Redis</h3><p>Redis作为一个open source key-value store，与传统的k-v存储开源方案相比，其value类型支持各种常见数据类型（如strings, hashes, lists, sets, sorted-sets, etc.），<br>正因如此，其可被用于多种应用场景。特别需要明确的是：当需要处理的数据能被内存完全容纳时，Redis才能发挥其优异的性能，即Redis works with an in-memory dataset。<br>备注：从v2.0开始到v2.4，Redis支持vitual memory的概念，即当数据集比物理内存大时，会将冷key的value交换到磁盘上，当被请求时，再重新换回主存。不过由于VM机制弊大于利，<br>从redis v2.4之后的版本（不包括2.4）开始，VM特性已被Redis弃用，详细说明可以参考这里。<br>Redis支持数据持久化（persistence），以便Redis服务因各种原因重启后，可以load之前已有数据，从而恢复服务状态。用户可根据实际使用情况选择两种持久化策略：</p>
<p>1) RDB方式：dump内存数据库至磁盘<br>2) AOF方式：将每个写操作记录到command log文件中，以便server重启时回放log以恢复数据状态（类似于MySQL的binlog）<br>Redis支持Master-Slave Replication，从库以全镜像方式同步主库数据，以防系统故障。<br>Redis目前还不支持集群，不过支持集群的版本已在作者开发计划中（cluster目前有alpha版本，尚未发布生产环境可用版本）。<br>虽无官方的集群实现，但业界主流做法是用Partitioning方式将数据集散列到不同的redis实例上，从而变相实现了对redis集群的支持，redis官网的这里对partitioning的实现思路<br>做了描述并推荐了twitter开源的一个支持redis的proxy - twemproxy（该proxy最初是作为memcached proxy开源的）。<br>有两个基本概念需要区分：Redis Master-Slave Replication和Redis Cluster，前者在两个库之间实现数据全镜像，后者则是将用户数据散列到不同机器上，<br>每个机器的Redis节点只hold一部分用户数据。    </p>
<p>个人感觉，两种方法都可以起到单点故障容错作用，只是实现方式及应用场合不同而已。<br>Redis还可以被用作Message Queue，支持的指令集见这里<br>关于Redis的更多基础介绍，可直接查看其官网文档。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/21/运维感悟（二）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/21/运维感悟（二）/" itemprop="url">
                  运维感悟（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Дата создания записи" itemprop="dateCreated datePublished" datetime="2016-12-21T10:00:38+08:00">
                2016-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维感悟/" itemprop="url" rel="index">
                    <span itemprop="name">运维感悟</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/21/运维感悟（二）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/21/运维感悟（二）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/21/运维感悟（二）/" class="leancloud_visitors" data-flag-title="运维感悟（二）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作为一位干了运维的老运维人员有幸读了一本叫做《凤凰项目》的书籍，还没有读完，先写一点感悟吧。<br>第一条感悟就是对自己所从事的工作有了整体大局观的思考；工作无外乎四类：第一类工作：项目内工作；<br>第二类工作项目工作；第三类工作变更工作；第四类工作是计划外工作(我称之为救火工作)。我们经常会被<br>计划外工作打乱自己的计划工作，导致其它工作进展缓慢。我身边也有这样的例子，每天忙得跟孙子似的，但是<br>还是不能更好的处理好自己的项目内工作。而计划外的工作我深入分析了下来源，还没有进行归类。攻击以及网络故障<br>等我就不说了。只说一些常见的系统故障吧。</p>
<p>敏捷文化盛行的今天，公司招聘了很多开发人员，我们经常看到运维与研发人员撕逼。其实我觉得都可以从制度流程上来<br>解决这些问题，再敏捷，一定得规章制度还是要有的。很多计划外工作的源头真的来自于研发，比如上线的新项目完全没有<br>按照集群的架构来开发，系统的健壮性，安全性问题等。这叫挖坑给自己跳，随着每天上线项目的增多，再加上墨菲定律的作用，<br>每天都会有不同项目出现宕机。这时候运维人员通常扮演的角色就是救火救火再救火。然后研发还会说运维不给力等等。其实我想说<br>不是运维不给力，作为公司制度的制定者，运维的管理者有发言权的大哥们，请你们一定不要把这干柴放进运维这个坑里面。一定要在<br>干柴进坑之前检查完。怎么做？方法也有很多，我这里只说说我的看法，每次有新项目上线前，从运维中抽调主力队员去参加新项目的<br>架构评审。凡是单点的（除了定时）服务一律不通过，没有经过测试压测的项目不准上线，并发等等，要从公司层面有一个制度，不要<br>等出了问题再想办法解决。这时候你会抱怨，我手下的这群小伙子天天在忙什么呀？我告诉你他们也不知道在干嘛，之前引进的火太多了，<br>要救火就是这样，今天就说到这里吧。</p>
<p>2016-12-23<br>解决之道,用数据，用生产力说不。从此这个公司和谐了。</p>
<p>深入了解公司之后，我们不妨再扩大下参考系。运维人员与研发撕逼，研发与产品撕逼，产品与业务撕逼。当然你也可以从业务撕逼到运维与研发撕逼看起。<br>这就是个动态的流。每天我们看到研发任务越来越重，运维压力越来越大。其实这都是一个通点；如何解决这些问题呢？从全局来解决，任何事情的产生都不是<br>说但从运维抓起，从研发抓起都不行。每一个环节都很重要，每一个人员都很重要。而解决这些问题提升战斗力，才是重中之重。首先解决技术债，每个团队的解决各自的。<br>产品一定要用数据来说服业务，我们开发量是什么样的。当然作为技术的研发人员呢？解决好自己的技术债，不要把一个迭代的问题拖到下一个迭代或者想走捷径。世界上真<br>没有捷径可走，每一个捷径都会成为你未来要救得火，到我们的生活中也是这样。扯得有点远了。解决好这个问题之后，我们就能理顺项目中的活以及日常变更。救火次数的减少，<br>恰恰提高了我们整个团队的生产力。啰嗦了这么多，不知道各位看明白没有？欢迎拍砖。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/20/k8s日志使用-四/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/20/k8s日志使用-四/" itemprop="url">
                  k8s日志使用(四)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Дата создания записи" itemprop="dateCreated datePublished" datetime="2016-12-20T15:55:14+08:00">
                2016-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/容器管理软件/" itemprop="url" rel="index">
                    <span itemprop="name">容器管理软件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/20/k8s日志使用-四/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/20/k8s日志使用-四/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/20/k8s日志使用-四/" class="leancloud_visitors" data-flag-title="k8s日志使用(四)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>logstash vs fluentd</p>
<h3 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">wget https://download.elastic.co/kibana/kibana/kibana-4.5.4-1.x86_64.rpm</div><div class="line">yum localinstall kibana-4.5.4-1.x86_64.rpm </div><div class="line">[root@ucloud-test-etcd03 ~]# rpm -qc kibana</div><div class="line">/opt/kibana/config/kibana.yml</div><div class="line">[root@ucloud-test-etcd03 ~]# vim /opt/kibana/config/kibana.yml </div><div class="line">elasticsearch.url: &quot;http://10.10.123.29:9200&quot;</div><div class="line">[root@ucloud-test-etcd03 ~]# systemctl enable kibana.service</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kibana.service to /usr/lib/systemd/system/kibana.service.</div><div class="line">[root@ucloud-test-etcd03 ~]# systemctl restart kibana.service </div><div class="line">[root@ucloud-test-etcd03 ~]# systemctl status kibana.service -l</div><div class="line">● kibana.service - no description given</div><div class="line">   Loaded: loaded (/usr/lib/systemd/system/kibana.service; enabled; vendor preset: disabled)</div><div class="line">   Active: active (running) since Tue 2016-12-20 16:55:26 CST; 1min 9s ago</div><div class="line"> Main PID: 21596 (node)</div><div class="line">   CGroup: /system.slice/kibana.service</div><div class="line">           └─21596 /opt/kibana/bin/../node/bin/node /opt/kibana/bin/../src/cli</div><div class="line"></div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:elasticsearch&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:elasticsearch&quot;,&quot;state&quot;:&quot;yellow&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to yellow - Waiting for Elasticsearch&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:kbn_vislib_vis_types&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:kbn_vislib_vis_types&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to green - Ready&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:markdown_vis&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:markdown_vis&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to green - Ready&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:metric_vis&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:metric_vis&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to green - Ready&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:spyModes&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:spyModes&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to green - Ready&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:statusPage&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:statusPage&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to green - Ready&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:table_vis&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:table_vis&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from uninitialized to green - Ready&quot;,&quot;prevState&quot;:&quot;uninitialized&quot;,&quot;prevMsg&quot;:&quot;uninitialized&quot;&#125;</div><div class="line">Dec 20 16:55:29 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:29+00:00&quot;,&quot;tags&quot;:[&quot;listening&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;message&quot;:&quot;Server running at http://0.0.0.0:5601&quot;&#125;</div><div class="line">Dec 20 16:55:34 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:34+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:elasticsearch&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:elasticsearch&quot;,&quot;state&quot;:&quot;yellow&quot;,&quot;message&quot;:&quot;Status changed from yellow to yellow - No existing Kibana index found&quot;,&quot;prevState&quot;:&quot;yellow&quot;,&quot;prevMsg&quot;:&quot;Waiting for Elasticsearch&quot;&#125;</div><div class="line">Dec 20 16:55:37 ucloud-test-etcd03 kibana[21596]: &#123;&quot;type&quot;:&quot;log&quot;,&quot;@timestamp&quot;:&quot;2016-12-20T08:55:37+00:00&quot;,&quot;tags&quot;:[&quot;status&quot;,&quot;plugin:elasticsearch&quot;,&quot;info&quot;],&quot;pid&quot;:21596,&quot;name&quot;:&quot;plugin:elasticsearch&quot;,&quot;state&quot;:&quot;green&quot;,&quot;message&quot;:&quot;Status changed from yellow to green - Kibana index ready&quot;,&quot;prevState&quot;:&quot;yellow&quot;,&quot;prevMsg&quot;:&quot;No existing Kibana index found&quot;&#125;</div><div class="line">[root@ucloud-test-etcd03 ~]# netstat -ntulp </div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </div><div class="line">tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      7632/etcd           </div><div class="line">tcp        0      0 10.10.151.214:2379      0.0.0.0:*               LISTEN      7632/etcd           </div><div class="line">tcp        0      0 10.10.123.29:2379       0.0.0.0:*               LISTEN      7632/etcd           </div><div class="line">tcp        0      0 10.10.123.29:2380       0.0.0.0:*               LISTEN      7632/etcd           </div><div class="line">tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      25872/rpcbind       </div><div class="line">tcp        0      0 10.10.123.29:9200       0.0.0.0:*               LISTEN      21418/java          </div><div class="line">tcp        0      0 10.10.123.29:9300       0.0.0.0:*               LISTEN      21418/java          </div><div class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      2008/sshd           </div><div class="line">tcp        0      0 0.0.0.0:49152           0.0.0.0:*               LISTEN      28528/glusterfsd    </div><div class="line">tcp        0      0 0.0.0.0:5601            0.0.0.0:*               LISTEN      21596/node          </div><div class="line">tcp        0      0 0.0.0.0:24007           0.0.0.0:*               LISTEN      28422/glusterd      </div><div class="line">tcp6       0      0 :::111                  :::*                    LISTEN      25872/rpcbind       </div><div class="line">tcp6       0      0 :::22                   :::*                    LISTEN      2008/sshd           </div><div class="line">udp        0      0 0.0.0.0:111             0.0.0.0:*                           25872/rpcbind       </div><div class="line">udp        0      0 10.10.151.214:123       0.0.0.0:*                           2210/ntpd           </div><div class="line">udp        0      0 10.10.123.29:123        0.0.0.0:*                           2210/ntpd           </div><div class="line">udp        0      0 127.0.0.1:123           0.0.0.0:*                           2210/ntpd           </div><div class="line">udp        0      0 0.0.0.0:123             0.0.0.0:*                           2210/ntpd           </div><div class="line">udp        0      0 0.0.0.0:33210           0.0.0.0:*                           445/avahi-daemon: r </div><div class="line">udp        0      0 0.0.0.0:607             0.0.0.0:*                           25872/rpcbind       </div><div class="line">udp        0      0 0.0.0.0:5353            0.0.0.0:*                           445/avahi-daemon: r </div><div class="line">udp6       0      0 :::111                  :::*                                25872/rpcbind       </div><div class="line">udp6       0      0 :::123                  :::*                                2210/ntpd           </div><div class="line">udp6       0      0 :::607                  :::*                                25872/rpcbind</div></pre></td></tr></table></figure>
<p>浏览器访问：<br><a href="http://10.10.123.29:5601/" target="_blank" rel="external">http://10.10.123.29:5601/</a><br><img src="images/11.png" alt="image"></p>
<p>#abac<br>abac</p>
<h3 id="集群部署kibana"><a href="#集群部署kibana" class="headerlink" title="集群部署kibana"></a>集群部署kibana</h3><p>很简单了，一句话，就是每个elasticsearch上面配置一个kibana，然后用nginx做upstream即可解决。</p>
<h3 id="对接fluentd（td-agent-日志"><a href="#对接fluentd（td-agent-日志" class="headerlink" title="对接fluentd（td-agent)日志"></a>对接fluentd（td-agent)日志</h3><p>目前我们将日志分为三类：<br>第一类日志： 宿主机日志，主要监控message日志；<br>第二类日志： docker宿主机，主要监控容器日志；<br>第三类日志：k8s的master和node，主要监控各个组件日志和容器日志。</p>
<h4 id="部署td-agent"><a href="#部署td-agent" class="headerlink" title="部署td-agent"></a>部署td-agent</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@ucloud-test-bj2c-master1 zhanglong]#  curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh</div><div class="line">安装fluent-plugin-elasticsearch插件</div><div class="line">http://docs.fluentd.org/articles/quickstart</div><div class="line">http://www.fluentd.org/plugins</div><div class="line">https://github.com/uken/fluent-plugin-elasticsearch</div><div class="line">[root@ucloud-test-bj2c-master1 zhanglong]# /usr/sbin/td-agent-gem install fluent-plugin-elasticsearch</div><div class="line">[root@ucloud-test-bj2c-master1 zhanglong]# /usr/sbin/td-agent-gem install fluent-plugin-typecast </div><div class="line"></div><div class="line">[root@ucloud-dev-node1 td-agent]# cat /etc/td-agent/td-agent.conf </div><div class="line">&lt;source&gt;</div><div class="line">    @type tail</div><div class="line">    path /var/log/messages</div><div class="line">    pos_file /var/log/td-agent/messages.log.pos</div><div class="line">    tag messages.log</div><div class="line">    format /^(?&lt;time&gt;[^ ]*\s*[^ ]* [^ ]*) (?&lt;host&gt;[^ ]*) (?&lt;ident&gt;[a-zA-Z0-9_\/\.\-]*)(?:\[(?&lt;pid&gt;[0-9]+)\])?(?:[^\:]*\:)? *(?&lt;message&gt;.*)$/</div><div class="line">    time_format %b %d %H:%M:%S</div><div class="line">&lt;/source&gt;</div><div class="line">&lt;match messages.**&gt;</div><div class="line">    @type copy</div><div class="line">    &lt;store&gt;</div><div class="line">      @type stdout</div><div class="line">    &lt;/store&gt;</div><div class="line">    &lt;store&gt;</div><div class="line">      @type elasticsearch</div><div class="line">      host 10.10.123.29</div><div class="line">      port 9200</div><div class="line">      logstash_format true</div><div class="line">      flush_interval 10s</div><div class="line">    &lt;/store&gt;</div><div class="line">&lt;/match&gt;</div><div class="line"></div><div class="line">重启服务</div><div class="line">/etc/initd.d/td-agent restart</div></pre></td></tr></table></figure>
<h4 id="登陆kibana查看数据"><a href="#登陆kibana查看数据" class="headerlink" title="登陆kibana查看数据"></a>登陆kibana查看数据</h4><p><img src="images/13.jpg" alt="image"></p>
<h4 id="k8s主机（10-10-220-246）"><a href="#k8s主机（10-10-220-246）" class="headerlink" title="k8s主机（10.10.220.246）"></a>k8s主机（10.10.220.246）</h4><p>```<br>详细地址可参考：<br><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons</a></p>
<p>#根据官方提供的dockerfile，修改td-agent.conf，制定镜像<br>[root@ucloud-test-bj2c-master1 fluentd-elasticsearch-image]# mkdir fluentd-es-image<br>[root@ucloud-test-bj2c-master1 fluentd-elasticsearch-image]# cd fluentd-es-image/<br>[root@ucloud-test-bj2c-master1 fluentd-elasticsearch-image]# vi Dockerfile<br>FROM index.tenxcloud.com/google_containers/fluentd-elasticsearch:1.17<br>MAINTAINER k8s “123@k8s.io”</p>
<h1 id="Copy-the-Fluentd-configuration-file"><a href="#Copy-the-Fluentd-configuration-file" class="headerlink" title="Copy the Fluentd configuration file."></a>Copy the Fluentd configuration file.</h1><p>COPY td-agent.conf /etc/td-agent/td-agent.conf</p>
<h1 id="Run-the-Fluentd-service"><a href="#Run-the-Fluentd-service" class="headerlink" title="Run the Fluentd service."></a>Run the Fluentd service.</h1><p>ENTRYPOINT [“td-agent”]</p>
<p>[root@ucloud-test-bj2c-master1 fluentd-elasticsearch-image]# vi td-agent.conf<br>…</p>
<p><match **=""><br>   type elasticsearch<br>   log_level info<br>   include_tag_key true<br>   host 10.10.123.29<br>   port 9200<br>…<br>[root@ucloud-test-bj2c-master1 fluentd-elasticsearch-image]# docker tag fluentd-elasticsearch:1.17.2  10.10.132.89/renmai-test/fluentd-elasticsearch:1.17.2<br>[root@ucloud-test-bj2c-master1 fluentd-elasticsearch-image]# docker push 10.10.132.89/renmai-test/fluentd-elasticsearch:1.17.2 </match></p>
<p>apiVersion: extensions/v1beta1<br>kind: DaemonSet<br>metadata:<br>  name: fluentd-elasticsearch<br>  namespace: kube-system<br>  labels:<br>    k8s-app: fluentd-logging<br>spec:<br>  template:<br>    metadata:<br>      name: fluentd-elasticsearch<br>      labels:<br>        k8s-app: fluentd-logging<br>    spec:<br>      containers:</p>
<pre><code>- name: fluentd-elasticsearch
  image: 10.10.132.89/renmai-test/fluentd-elasticsearch:1.17-2
  - name: KUBERNETES_URL
    value: &quot;http://10.10.220.246:8080&quot;
  - name: VERIFY_SSL
    value: &quot;false&quot;
  volumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
terminationGracePeriodSeconds: 30
volumes:
- name: varlog
  hostPath:
    path: /var/log
- name: varlibdockercontainers
  hostPath:
    path: /var/lib/docker/containers
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Zero" />
          <p class="site-author-name" itemprop="name">Zero</p>
          <p class="site-description motion-element" itemprop="description">走过山山水水,脚下高高低低,人生难得糊涂！</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">82</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">58</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.unixhot.com/" title="运维社区" target="_blank">运维社区</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.yfshare.vip" title="Jack Wang Blog" target="_blank">Jack Wang Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.25555579.com/" title="背锅侠" target="_blank">背锅侠</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zero</span>
</div>

<script  language="javascript">
window.onload = function() { 
var show = document.getElementById("show"); 
setInterval(function() { 
var time = new Date(); 
// 程序计时的月从0开始取值后+1 
var m = time.getMonth() + 2; 
//根据自己博客的创建时间更改数值 
var t = "Welcome to Zero's  Blog! 宝宝已经存在"+(time.getFullYear()-2017) + "年" + m + "月" 
+ time.getDate() + "天 " + time.getHours() + "时" 
+ time.getMinutes() + "分" + time.getSeconds() + "秒了"; 
show.innerHTML = t; 
}, 1000); 
}; 
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ecc9733854359d44324d6063c4776ffb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>





<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>

<span id="busuanzi_container_site_uv">
  你是本站的第<span id="busuanzi_value_site_uv"></span>个访客
</span>
<!--

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>




-->
        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zerosre"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("DoxG0uQxF81TSYnLX2XSmf3s-gzGzoHsz", "Q4wLV6Vdxd4YnCWesJ0qk9cO");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
