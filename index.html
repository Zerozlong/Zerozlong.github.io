<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Zero, Welcom!" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="走过山山水水,脚下高高低低,人生难得糊涂！">
<meta property="og:type" content="website">
<meta property="og:title" content="Zero">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Zero">
<meta property="og:description" content="走过山山水水,脚下高高低低,人生难得糊涂！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zero">
<meta name="twitter:description" content="走过山山水水,脚下高高低低,人生难得糊涂！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> Zero </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Zero</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/21/glusterfs优化思想/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/21/glusterfs优化思想/" itemprop="url">
                  glusterfs优化思想
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-21T11:50:25+08:00">
                2017-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式存储/" itemprop="url" rel="index">
                    <span itemprop="name">分布式存储</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/21/glusterfs优化思想/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/21/glusterfs优化思想/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/03/21/glusterfs优化思想/" class="leancloud_visitors" data-flag-title="glusterfs优化思想">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>互联网的触角已融入到生活细节，人们习惯将越来越多的照片、短视频等上传至服务器存储、调用。在互联网(尤其是移动互联网)、物联网、云计算、大数据等高速发展的大背景下，数据呈现爆炸式地增长。“小文件”，特别是海量小文件的存储越来越被人们所需要。<br>业界也有很多文件系统专门针对小文件进行优化的分布式文件系统。例如国外的Facebook专门推出的Haystack，国内淘宝的开源TFS等。针对GlusterFS，作者谈谈如何在Gluster上对海量小文件场景进行优化。<br>问题概述<br>海量小文件，当文件数量达到千万级、亿级、十亿级甚至百亿等，在元数据读写、存储效率等要求越来越高，海量小文件通常是业界的一大难题。<br>通常我们认为文件大小小于1MB的文件为小文件，GlusterFS文件系统他的设计在海量小文件场景有他的优劣，后面将细致分析GlusterFS在这种用户场景下的优劣势，<br>已经如何扬长避短，对小文件进行优化。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>衡量存储性能主要用两个关键指标，即IOPS和吞吐量（bandwidth）。IOPS（Input/Output per Second）即每秒读写次数，是随机读写主要需要关注的指标；吞吐量指每秒读写的数据<br>量，是顺序大文件读写主要关注的指标。</p>
<p>一般文件系统对文件的读写操作分成几个阶段，查询（lookup），打开/创建（open/create），读写（read/write），关闭（close）。<br>查询，创建和读写基本上是对磁盘操作，其他操作基本上在内核就OK。而小文件读写，在磁盘表现上基本上是随机读写。</p>
<h3 id="GlusterFS在小文件操作上的优劣势"><a href="#GlusterFS在小文件操作上的优劣势" class="headerlink" title="GlusterFS在小文件操作上的优劣势"></a>GlusterFS在小文件操作上的优劣势</h3><p>主要是针对GlusterFS本身特点分析在小文件操作上的优劣势。<br>GlusterFS在架构设计上，有一个特色就是metadata跟数据在一起，没有集中式的metadata服务。这个跟业界其他分布式存储上有很大的差别。其他分布式存储，<br>像ceph、hdfs等，都是有独立的metadata服务，管理整个集群中的metadata。这个特点造成GlusterFS有自己的优势，也有劣势。</p>
<p>（1） 优势<br>·在查找工作时候，在server端会有entry（关于最后落盘文件的元数据和分布）的缓存，这样在open操作时候不需要再操作一次磁盘。而metadata分离的文件系统，<br>查询工作是在metadata服务上进行，要实际open或者读写时候，需要额外去读取一次disk查找落盘文件的元数据和分布情况。<br>·由于metadata和数据结合紧密，理论上，scale out更为线性。添加节点，该节点的所有metadata都在那个节点上。</p>
<p>（2） 劣势<br>·在进行目录遍历相关操作时候，由于没有集中式的metadata服务，遍历目录，需要遍历所有brick服务相应的目前取出相关的文件列表。<br>并且，由于Gluster默认会使用readdirp操作（readdirp是对readdir扩展操作，在返回时候，会将文件的相关的metadata同时返回，readdir与readdirp区别类似ls与ls -l），<br>这样每次可以返回的entry数量少，交互次数相应更多，导致ls或者find等遍历操作会变成非常慢（这个问题在gluster brick数量多或者文件数量多时候回比较严重）。<br>·Gluster在每一个brick节点都有隐藏目录.glusterfs，这个目录是含本机所有的一般文件的硬链接，和目录等文件的软连接。使得对于后端文件系统的inode数量翻倍。</p>
<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><p>从Gluster本身，以及使用方式上来描述如何针对GlusterFS的海量小文件场景进行性能优化。</p>
<h4 id="Gluster方面"><a href="#Gluster方面" class="headerlink" title="Gluster方面"></a>Gluster方面</h4><p>Gluster Feature<br>Gluster在3.7planning中计划实现对小文件的优化Feature.但是，这个是要DHT 4.0实现，这里DHT 4.0在设计实现阶段。需要在gluster v4上实现的Feature。期待Gluster官方实现这个Feature。<br>撤销lookup-unhash<br>Lookup-unhash配置是在dht上生效的，是指在查找时候，如果在hash所在节点上没有找到相应文件的话，去所有节点上查找一遍。<br>撤销这个配置项，通过如下命令：<br>gluster volume set lookup-unhashed off<br>开启write-behind和flush-behind<br>这两个配置可以开启异步写模式，对于io来说，上层不需要等待太多时间。<br>关闭io-cache，readahead等xlator<br>这些xlator主要是为了大文件设计的，在小文件场景上会有一些性能损耗，需要关闭。</p>
<h4 id="Brick数量设置"><a href="#Brick数量设置" class="headerlink" title="Brick数量设置"></a>Brick数量设置</h4><p>这一块对于Gluster来说是很重要的事情。Gluster客户端会跟所有brick进程建立链接，当brick数量多了以后，对于客户端连接上会变慢，需要等所有brick连接回应后采用响应。<br>另外，brick数量太少的话，每个brick数据太多，io延时会相应变长。这里需要平衡一下。笔者没有细测，这里需要有一定测试。</p>
<h4 id="底层文件系统"><a href="#底层文件系统" class="headerlink" title="底层文件系统"></a>底层文件系统</h4><p>底层文件系统推荐使用xfs，这里红帽的测试基本上是基于xfs上测试。另外，xfs的特性更适合小文件系统。<br>另外，如果热数据不多的场景，关闭文件系统的cache，使用cache在海量文件时候，在内存满时候，查找内存是否命中，以及内存的释放上对io性能造成额外的开销。<br>这里，底层文件系统上，可以做一些加速。<br>例如，在明显有热流量的场景下，可以使用flashcache方式，指定合适的策略，对底层文件系统进行加速。</p>
<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><p>目录层级设计<br>目录层级每多一级，对于一次文件的Open行为很可能会多查找一次磁盘。但是目录层级太少，会导致一个目录底下过多的文件，使得同一个目录下面查找相应文件的时间变长。<br>这里建议使用256*256方式，即在底下ab/cd/file。其中ab和cd是指两个两位16进制的数。<br>这里可以在创建好volume以后预先创建好目录结构。<br>另外，在这种情况下，如果要改代码，可以在brick进程即（glusterfsd）上缓存这个目录结构的信息，使得对这个目录结构的查找时候不需要对硬盘过多的操作。</p>
<h4 id="不使用遍历操作"><a href="#不使用遍历操作" class="headerlink" title="不使用遍历操作"></a>不使用遍历操作</h4><p>理由前文已经说过，对于gluster目前版本的架构来说ls这种遍历操作会对整个文件系统造成很大的开销，以及本身性能很慢。看社区的planning，可以期待在4.0版本上这个有所改善。但是目前情况上还是避免这类型操作。</p>
<h4 id="小文件聚合"><a href="#小文件聚合" class="headerlink" title="小文件聚合"></a>小文件聚合</h4><p>存储业界对于海量小文件性能调优上，还是将小文件聚合这种方案更为有效。这里需要注意几个限制：这里小文件聚合后上层需要记录好聚合后所在的file和offset等信息，以及这里小文件聚合场景中文件是一次写，后面不做变更，要不然实现起来会有很多劣势。<br>由于gluster尚未实现这种Feature，需要上层应用来实现，或者自己修改gluster代码。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cluster.lookup-unhashed: off</div><div class="line">performance.io-thread-count: 24</div><div class="line">auth.allow: 192.168.134.11,192.168.168.10,172.31.160.93</div><div class="line">transport.address-family: inet</div><div class="line">performance.readdir-ahead: on</div><div class="line">nfs.disable: on</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/20/glusterfs中继器调优/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/20/glusterfs中继器调优/" itemprop="url">
                  glusterfs中继器调优
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-20T14:45:42+08:00">
                2017-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式存储/" itemprop="url" rel="index">
                    <span itemprop="name">分布式存储</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/20/glusterfs中继器调优/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/20/glusterfs中继器调优/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/03/20/glusterfs中继器调优/" class="leancloud_visitors" data-flag-title="glusterfs中继器调优">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="write-behind（默认on）"><a href="#write-behind（默认on）" class="headerlink" title="write-behind（默认on）"></a>write-behind（默认on）</h3><p>luster volume set test write-behind on</p>
<p>Write Behind Translator （后写）<br>通常情况下，写操作会比读要慢。通过使用”aggregated background write”技术，write-behind translator 相当显著地改善了写的性能。更确切地说，<br>大量小的写操作被集中起来，形成少量的、大一些的写操作，并且进行后台写处理(non-blocking)。后写方式在client端上聚合了写操作，减小了必须传递的网络包数量。<br>在server端，它帮助服务器优化写的磁盘寻道时间。</p>
<p>aggregate-size<br>该选项决定了在汇聚写操作之前块的大小。参照你的连接速度、RAM的大小，以及工作负载情况，你可以调整这个值。默认的，该值为128KB，能够比较好的满足大多数应用情况。<br>无限制的增加和减小这个值可能会带来性能上的降低。你可以逐渐调整和分析，慢慢找出一个最优化的结果。</p>
<p>flush-behind<br>该选项可以直接通过命令 gluster volume set test flush-behind 的形式进行设置，但实际上，该参数是write-behind的一个选项，<br>如果write-behind为off，只设置flush-behind应该是没有意义的。该选项也同样是为了提升处理大量小文件的性能。<br>在这个选项里close()/flush()能够被堆到后台，允许客户端去处理下一个请求。默认值是on。</p>
<p>注意:<br>通常情况下，protocol translator对于一个请求或者转发的数据包有一个4MB的上限。因此，如果你在client端用了上面的write-behind(大多数会如此)，<br>并且aggregate-size大于4MB，他也不会发出大的数据包。</p>
<h3 id="read-ahead（默认on）"><a href="#read-ahead（默认on）" class="headerlink" title="read-ahead（默认on）"></a>read-ahead（默认on）</h3><p>gluster volume set test read-ahead on<br>Read Ahead Translator （预读）<br>基于预设值，read-ahead会顺序地预取一些块。当你的应用忙于处理一些数据的时候，GlusterFS能够预读下一批等待处理的数据。<br>这样能够使得读取操作更加流畅和迅速。而且，工作起来像一个读的集合器一样（read-aggregator），也就是说，将大量的、零散的读取操作集合成少量的、<br>大一些的读操作，这样，减小了网络和磁盘的负载。page-size 描述了块的大小。page-count 描述了预读块的总数量。</p>
<p>注意:<br>这个translator比较适合于应用在IB-verbs transport环境里。在百兆和千兆以太网接口、没有read-ahead的环境下，能够达到这种连接的最高速度。</p>
<p>gluster volume set test quick-read on</p>
<p>从描述上看，该选项只对fuse有用，同时，如果文件的大小大于默认的64k，则该选项也不起作用。<br>Translator performance/quick-read</p>
<p>该中继器用来提高小文件读性能。<br>通过网络对文件系统进行操作开销很大，因此，quick-read使用glusterfs内部get接口来一次执行多个posix系统调用open/read/close，一次get调用包含：一个open调用 + 多个read调用 + 一个close调用。<br>This translator improves performance of read on small files. Over a posix interface, files are read using the apis open, read and close. For a filesystem implemented over a network, the round trip overhead of these calls can be significant. Hence quick-read uses the glusterfs internal get interface to implement posix abstraction of using open/read/close for reading of files there by reducing the number of calls over network from n to 1 where n = no of read calls + 1 (open) + 1 (close).<br>Example:<br>volume quick-read<br>  type performance/quick-read<br>  option cache-timeout nsecs (1 second)<br>  option max-file-size nbytes (64Kb)<br>  subvolumes client<br>end-volume</p>
<p>cache-timeout<br>缓存失效验证时间，默认值1秒。<br>Timeout for validation of cached file. On timeout stats of the file is compared with that of cached copy. If the file is found to be changed after it is cached, the cache is flushed. The default timeout value is 1 second.<br>max-file-size</p>
<p>可以使用get接口读取的文件最大值，默认值是64KB。当文件大于该值，则使用标准的open/read/close调用。</p>
<p>Maximum size of the file that can be fetched using get interface. Files bigger than this are read using the normal open/read/close. Note that this option controls only how quick-read behaves. Irrespective of the value this option, the applications running on glusterfs continue to use the normal open/read/close interface. Default value of this option is 64 kilo bytes.</p>
<p>glusterfs3.4把quick-read（3.3就这一个translaotr）分解为open-behind和quick-read。原来设计不管操作文件的目的是什么，都要获取真正的fd。重构后，可以根据文件操作目的，如果是修改文件内容，就在后台打开文件并进行操作。如果仅仅是fstat等类似操作，就利用匿名fd来进行，不会等待真正的fd。这样根据操作目的，优化了性能。在lookup时，根据需要设置xdata key，在posix translator层就抓取文件内容。read操作执行到quick-read层时就返回文件内容。</p>
<h3 id="open-behind（默认on）"><a href="#open-behind（默认on）" class="headerlink" title="open-behind（默认on）"></a>open-behind（默认on）</h3><p>gluster volume set test open-behind on<br>Perform open in the backend only when a necessary FOP arrives (e.g writev on the FD, unlink of the file). When option is disabled, perform backend open right after unwinding open().</p>
<h3 id="stat-prefetch（默认on）"><a href="#stat-prefetch（默认on）" class="headerlink" title="stat-prefetch（默认on）"></a>stat-prefetch（默认on）</h3><p>即：performance/md-cache<br>gluster volume set test stat-prefetch on<br>meta-data caching translator in the volume。<br>网上有说法：<br>为规避客户端元数据不一致，把客户端的metadata cache禁用，即配置performance.md-cache-timeout 0。<br>有可能正确，待深入分析，暂用默认值。</p>
<p>force-readdirp参数：<br>Convert all readdir requests to readdirplus to collect stat info on each entry.</p>
<h3 id="io-threads（默认on，16线程）"><a href="#io-threads（默认on，16线程）" class="headerlink" title="io-threads（默认on，16线程）"></a>io-threads（默认on，16线程）</h3><p>gluster volume set test io-thread-count 16</p>
<p>IO线程中继(performance/io-threads）属于性能调整中继的一种，作用是增加IO的并发线程，以提高IO性能。<br>IO线程中继试图增加服务器后台进程对文件元数据读写I/O的处理能力。由于GlusterFS服务是单线程的，使用IO线程转换器可以较大的提高性能。这个转换器最好是被用于服务器端，而且是在服务器协议转换器后面被加载。<br>IO线程操作会将读和写操作分成不同的线程。同一时刻存在的总线程是恒定的并且是可以配置的。</p>
<p>之前GlusterFS Translators v1.3手册对io-threads描述，和当前实现相比可能有出入：<br>AIO增加了异步（后台）读写的功能。通过加载这个translator，你可以利用server的空闲时间去处理新的任务。当server在 DMA方式处理读或者写操作的时候，CPU、内存或者网络并没有被使用。这个translator可以将资源更好的利用起来去处理和增加当前的I/O性能。<br>注意:</p>
<ol>
<li>io-threads translator 只有在unify之上或者在Server protocol之下才会有效果。如果在unify和namespace brick之间，因为没有文件io的处理，所以不会有效果。</li>
<li>‘thread-count’小于或等于你的CPU数量。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/20/glusterfs中继器/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/20/glusterfs中继器/" itemprop="url">
                  glusterfs中继器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-20T14:30:49+08:00">
                2017-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式存储/" itemprop="url" rel="index">
                    <span itemprop="name">分布式存储</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/20/glusterfs中继器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/20/glusterfs中继器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/03/20/glusterfs中继器/" class="leancloud_visitors" data-flag-title="glusterfs中继器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="性能相关中继器"><a href="#性能相关中继器" class="headerlink" title="性能相关中继器"></a>性能相关中继器</h3><p>write-behind, read-ahead, io-cache, quick-read, open-behind, stat-prefetch(md-cache), io-threads(默认server端)<br>以上中继器默认全部开启，symlink-cache默认关闭。<br>NFS相关性能优化中继器<br>默认开启：<br>performance.nfs.write-behind<br>默认关闭：<br>performance.nfs.read-ahead<br>performance.nfs.io-cache<br>performance.nfs.quick-read<br>performance.nfs.stat-prefetch<br>performance.nfs.io-threads<br>performance.force-readdirp</p>
<p>默认配置中继<br>在./vols/test/test-fuse.vol（客户端）文件中，默认会配置如下中继器：<br>dht和性能相关的write-behind, read-ahead, io-cache, quick-read, open-behind, stat-prefetch(md-cache).</p>
<p>在./vols/test/test.node1.data-disk3.vol同类（服务器端）文件中，默认会设置如下中继器参数：<br>posix、access-control、locks、io-threads、index、maker</p>
<h3 id="默认配置信息"><a href="#默认配置信息" class="headerlink" title="默认配置信息"></a>默认配置信息</h3><p>默认配置项值<br>cache-size<br>io-cahce：cache-size：默认32MB<br>Size of the read cache<br>quick-read：cache-size：默认128MB<br>Size of the read cache</p>
<p>gluster volume set test cache-size 32MB</p>
<p>该命令导致的cache-size更新包含两个部分，一个是io-cache里对应的cache大小，一个是quick-read里的cache大小。<br>从源代码上看，这两个cache-size对应同一个key，所以会出现一改全改的现象，应该是一个bug。<br>read-ahead：page-count：默认值4<br>key为performance.read-ahead-page-count，可以通过该选项进行设置。<br>gluster volume set test read-ahead-page-count 4<br>Number of pages that will be pre-fetched</p>
<p>write-behind：”cache-size”或者”window-size”：默认值1MB<br>key为performance.write-behind-window-size，可以通过该选项进行设置。</p>
<p>gluster volume set test write-behind-window-size 1MB<br>Size of the write-behind buffer for a single file (inode).</p>
<p>io-threads：thread-count：默认16<br>key：performance.io-thread-count<br>gluster volume set test io-thread-count 16</p>
<p>Number of threads in IO threads translator which perform concurrent IO operations at a given time</p>
<p>该配置保存在/vols/test/test.node1.data-disk3.vol同类文件中。<br>md-cache：md-cache-timeout：默认值1（亦stat-prefetch）<br>gluster volume set test md-cache-timeout 1<br>该操作会更改md-cache中继器md-cache-timeout选项的默认值<br>Time period after which cache has to be refreshed<br>io-cache：cache-timeout：默认值1<br>key：performance.cache-refresh-timeout<br>gluster volume set test cache-refresh-timeout 1<br>cache-timeout：The cached data for a file will be retained till ‘cache-refresh-timeout’ seconds, after which data re-validation is performed.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/20/glusterfs调优/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/20/glusterfs调优/" itemprop="url">
                  glusterfs基础调优（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-20T11:48:15+08:00">
                2017-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式存储/" itemprop="url" rel="index">
                    <span itemprop="name">分布式存储</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/20/glusterfs调优/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/20/glusterfs调优/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/03/20/glusterfs调优/" class="leancloud_visitors" data-flag-title="glusterfs基础调优（一）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>GlusterFS性能调优基本思路主要包括三个部分，分别是硬件调优、操作系统调优和GlusterFS自身参数调优。</p>
<p>正常情况下，当硬件购买之后，已经没有什么可调的空间，最多就是更换一些性能更高的磁盘，当然这对glusterfs来说对性能帮助已经非常大了，<br>gluster对cpu本身要求并不是很高，性能瓶颈往往会出现在网络和磁盘这两块。</p>
<p>操作系统性能调优空间也不是很大，主要还是配合特定的应用场景，如果gluster和其他应用分享计算资源的话，还需要考虑操作系统配置对其他应用的性能影响，从方便运维的角度看，不推荐gluster和其他应用共享计算资源。</p>
<p>glusterfs自身性能调优对性能影响较大，好在默认情况下，gluster性能相关中继器都是打开的，默认都会提供比较高的性能，但是还是会有一些调优的空间，其中一个最主要的原因是gluster默认配置应对的是普通服务器，<br>对于部署在高性能服务器上的gluster来说，可调的空间就更大，原因是高性能服务器会提供更多内存和CPU。</p>
<h3 id="调优说明"><a href="#调优说明" class="headerlink" title="调优说明"></a>调优说明</h3><p>对gluster进行性能调优，主要调的是性能相关的中继器，默认情况下，所有的性能中继器都是打开的，给人的感觉就是没法调了，已经是最优了，<br>但实际情况往往不是这样的，还是要根据具体的应用场景，有些性能中继器在特定场合下反而会降低性能，其实对gluster性能影响很大的是gluster集群的部署方案，如果部署比较合理，性能原生就比较好，不需要做过多的配置，这也印证了gluster的简单好用和高性能。<br>gluster非常适合大文件读写的带宽型应用，诸如视频存储、HPC高性能计算、容器镜像存储、冷数据存储、日志存储、数据备份等应用场景。<br>但gluster并不擅长小文件读写的IOPS型应用，需要综合硬件、软件和系统进行优化。</p>
<p>参考调优配置说明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">单个集群规模          64节点   受集群管理模式限制，大规模集群有压力</div><div class="line">每卷最大客户端数量    &lt;= 1000个    Brick并发连接数量不能太大</div><div class="line">每节点brick数量      4－8个        Brick进程太多占用系统资源，并且启动时会出现部分brick进程启动失败现象</div><div class="line">单个brick容量       &lt;= 100 TB       平衡容量与性能，本地文件系统限制</div><div class="line">RAID/LVM           多盘组成RAID      单个Brick容量和性能，控制brick数量</div><div class="line">Brick文件系统       XFS           稳定，16TB以上大容量，格式化快</div><div class="line">卷类型            哈希复制卷          高可用，条带卷不成熟</div><div class="line">数据网络           10GbE           内部通信不能有瓶颈，尤其是NAS协议</div><div class="line">访问协议          POSIX            原生高可用，性能</div></pre></td></tr></table></figure></p>
<p>其它可以调整参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">auth.allow / auth.reject  IP访问授权  *(allow all)   IP地址</div><div class="line">cluster.min-free-disk   剩余磁盘空间阈值，超出将进行数据均衡并记录日志  10%  百分比</div><div class="line">network.frame-timeout  请求等待时间    1800s   0-1800</div><div class="line">network.ping-timeout   客户端等待时间   42s    0-42</div><div class="line">nfs.disabled        关闭NFS服务    off    off|on</div><div class="line">performance.io-thread-count  IO线程数   16     0-65 </div><div class="line">performance.cache-refresh-timeout  缓存校验周期     1s       0-61</div><div class="line">performance.cache-size       全局读缓存大小  io-cahce: 32MB        </div><div class="line">quick-read: 128MB  </div><div class="line">performance.io-thread-count      I/O并发数量  16   非零整数</div><div class="line">cluster.stripe-block-size    条带大小          128KB</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/16/glusterfs压测/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Zero">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zero">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zero" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/16/glusterfs压测/" itemprop="url">
                  glusterfs压测
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-16T11:03:31+08:00">
                2017-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式存储/" itemprop="url" rel="index">
                    <span itemprop="name">分布式存储</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/16/glusterfs压测/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/16/glusterfs压测/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/03/16/glusterfs压测/" class="leancloud_visitors" data-flag-title="glusterfs压测">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h3><p>公司早期是初创公司，在数据存储选型上使用的是硬件nas。三年之后数据量达到了30T，这个时候单一nas存储需要扩容。</p>
<h3 id="矛盾"><a href="#矛盾" class="headerlink" title="矛盾"></a>矛盾</h3><p>传统nas扩容不能做到无缝扩容，价格昂贵，即便可以扩容，单点故障经常发生。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>分布式存储。ceph/glusterfs/fastdfs</p>
<h3 id="why-glusterfs？"><a href="#why-glusterfs？" class="headerlink" title="why glusterfs？"></a>why glusterfs？</h3><p>分布式存储。为什么要做压测？因为很多应用程序不会告诉你它要如何使用你的gluster卷。<br>简而言之，使用客户端分析来理解“为什么我的应用程序无响应”？并使用服务器端性能分析来了解Gluster卷的繁忙程度，<br>应用于它的是什么样的工作负载（即大多数是读取的是小文件？），以及I/O负载的扩展程度跨越卷。</p>
<h3 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h3><h4 id="server端准备"><a href="#server端准备" class="headerlink" title="server端准备"></a>server端准备</h4><p>首先创建一个hash逻辑卷，在测试环境。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">gluster volume create test replica 3  gluster04.pro.pub.component.com:/gluster_brick1/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick1/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick1/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick2/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick2/b1 </div><div class="line">gluster06.pro.pub.component.com:/gluster_brick2/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick3/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick3/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick3/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick4/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick4/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick4/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick5/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick5/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick5/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick6/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick6/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick6/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick7/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick7/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick7/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick8/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick8/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick8/b1 \</div><div class="line">gluster04.pro.pub.component.com:/gluster_brick9/b1 \</div><div class="line">gluster05.pro.pub.component.com:/gluster_brick9/b1 \</div><div class="line">gluster06.pro.pub.component.com:/gluster_brick9/b1</div></pre></td></tr></table></figure></p>
<p>三条命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gluster volume profile test start</div><div class="line">gluster volume profile test info</div><div class="line">gluster volume profile test stop</div></pre></td></tr></table></figure></p>
<h4 id="测试类型"><a href="#测试类型" class="headerlink" title="测试类型"></a>测试类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fio:用于大文件I/O测试；</div><div class="line">smallfile：用于纯工作在小文件测试；</div><div class="line">iozone：用于纯工作负载大文件测试；</div><div class="line">parallel-libgfapi：用于纯工作负载libgfapi测试；</div></pre></td></tr></table></figure>
<h4 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h4><h5 id="fio"><a href="#fio" class="headerlink" title="fio"></a>fio</h5><p>首先安装fio软件,防火墙打开8765端口。然后在不同的主机上启动fio实例，注意尽可能接近同时启动所有fio实例，限制每个线程吞吐量，并制定运行持续时间，<br>而不是指定数量的数据。<br>fio基于最后一个线程完成测试来计算吞吐量。相反，iozone默认基于第一个线程何时完成工作负载来计算吞吐量。这可以导致iozone的更高吞吐量结果，但是我们可以通过<br>制定测试的时间来克服此限制。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget http://brick.kernel.dk/snaps/fio-2.1.tar.gz</div><div class="line">tar zxvf fio-2.1.tar.gz</div><div class="line">cd fio-2.1</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure></p>
<h6 id="随机读测试"><a href="#随机读测试" class="headerlink" title="随机读测试"></a>随机读测试</h6><p>fio -filename=/test/1.txt  -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=10 -runtime=1000 -name=jicki<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">filename=/test/1.txt 测试文件名称，通常选择需要测试的盘的data目录</div><div class="line">direct=1 测试过程绕过机器自带的buffer。使测试结果更真实。</div><div class="line">rw=randwrite 测试随机写的I/O</div><div class="line">ioengine=psync io引擎使用pync方式</div><div class="line">rw=randrw 测试随机写和读的I/O</div><div class="line">bs=16k 单次io的块文件大小为16k</div><div class="line">bsrange=512-2048 同上，提定数据块的大小范围</div><div class="line">size=200g 本次的测试文件大小为200g，以每次16k的io进行测试。</div><div class="line">numjobs=10 本次的测试线程为10.</div><div class="line">runtime=1000 测试时间为1000秒，如果不写则一直将200g文件分16k每次写完为止。</div><div class="line">group_reporting 关于显示结果的，汇总每个进程的信息。</div><div class="line">lockmem=1g 只使用1g内存进行测试。</div><div class="line">zero_buffers 用0初始化系统buffer。</div><div class="line">nrfiles=8 每个进程生成文件的数量。</div><div class="line">rwmixwrite=30 在混合读写的模式下，写占30%</div></pre></td></tr></table></figure></p>
<p>fio -filename=/test/1.txt –direct=1 –iodepth 1 –thread –rw=randrw –rwmixread=70 –ioengine=psync –bs=16k –size=200G –numjobs=30 -runtime=100 –group_reporting \<br> –name=test</p>
<p>fio -filename=/test/hehe -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=4k -size=50G -numjobs=32 -runtime=200  -name=test1</p>
<h4 id="smallfile"><a href="#smallfile" class="headerlink" title="smallfile"></a>smallfile</h4><p>smallfile是一个基于python的小文件生成器。可用于测试整个集群中各种元数据密集型工作负载的性能。主要设计用来补充使用iozone测量大文件工作负载的性能。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SMF=&quot;./smallfile_cli.py --top /mnt/glusterfs/smf --host-set h1,h2,h3,h4 --threads 8 --file-size 4 --files 10000 --response-times Y &quot;</div><div class="line">    $SMF --operation create</div><div class="line">    for s in $SERVERS ; do ssh $h &apos;echo 3 &gt; /proc/sys/vm/drop_caches&apos; ; done</div><div class="line">    $SMF --operation read</div><div class="line">    $SMF --operation append</div><div class="line">    $SMF --operation rename</div><div class="line">    $SMF --operation delete</div></pre></td></tr></table></figure></p>
<h4 id="iozone"><a href="#iozone" class="headerlink" title="iozone"></a>iozone</h4><p>这个工具虽然具有局限性，但是配合使用+-m选项来做分布式测试非常好。在做测试的时候，不推荐使用-a选项进行自动化测试。具体原因如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1、-a不允许您在测试之前删除服务器中的读取缓存；</div><div class="line">2、大多数被测量的数据点与要解决的问题无关（我还没搞明白）；</div><div class="line">3、单线程测试是一个重要的用例，但要充分利用可用的硬件，通常需要进行多线程甚至多主机测试。</div></pre></td></tr></table></figure></p>
<p>请考虑使用“-c -e”选项来测量数据到达持久存储所需的时间。 “-C”选项允许您查看每个线程参与测试的数量。<br> “ - + n”允许您通过跳过重新读取和重写测试来节省时间。 “-w”选项告诉iozone不要删除它访问的任何文件，以便后续测试可以使用它们。 在每个测试中指定这些选项：<br>i参数说明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">-i N 用来选择测试项, 比如Read/Write/Random 比较常用的是0 1 2,可以指定成-i 0 -i 1 -i2</div><div class="line">   0=write/rewrite</div><div class="line">  1=read/re-read</div><div class="line">  2=random-read/write</div><div class="line">  3=Read-backwards</div><div class="line">  4=Re-write-record</div><div class="line">  5=stride-read</div><div class="line">  6=fwrite/re-fwrite</div><div class="line">  7=fread/Re-fread</div><div class="line">  8=random mix</div><div class="line">  9=pwrite/Re-pwrite</div><div class="line">  10=pread/Re-pread</div><div class="line">  11=pwritev/Re-pwritev</div><div class="line">  12=preadv/Re-preadv</div></pre></td></tr></table></figure></p>
<h4 id="各种测试的定义"><a href="#各种测试的定义" class="headerlink" title="各种测试的定义"></a>各种测试的定义</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Write: 测试向一个新文件写入的性能。当一个新文件被写入时，不仅仅是那些文件中的数据需要被存储，还包括那些用于定位数据存储在存储介质的具体位置的额外信息。</div><div class="line">       这些额外信息被称作“元数据”。它包括目录信息，所分配的空间和一些与该文件有关但又并非该文件所含数据的其他数据。拜这些额外信息所赐，Write的性能通常会比Re-write的性能低。</div><div class="line"></div><div class="line">Re-write: 测试向一个已存在的文件写入的性能。当一个已存在的文件被写入时，所需工作量较少，因为此时元数据已经存在。Re-write的性能通常比Write的性能高。</div><div class="line"> </div><div class="line">Read: 测试读一个已存在的文件的性能。</div><div class="line"> </div><div class="line">Re-Read: 测试读一个最近读过的文件的性能。Re-Read性能会高些，因为操作系统通常会缓存最近读过的文件数据。这个缓存可以被用于读以提高性能。</div><div class="line"> </div><div class="line">Random Read: 测试读一个文件中的随机偏移量的性能。许多因素可能影响这种情况下的系统性能，例如：操作系统缓存的大小，磁盘数量，寻道延迟和其他。</div><div class="line"> </div><div class="line">Random Write: 测试写一个文件中的随机偏移量的性能。同样，许多因素可能影响这种情况下的系统性能，例如：操作系统缓存的大小，磁盘数量，寻道延迟和其他。</div><div class="line"> </div><div class="line">Random Mix: 测试读写一个文件中的随机偏移量的性能。同样，许多因素可能影响这种情况下的系统性能，例如：操作系统缓存的大小，磁盘数量，寻道延迟和其他。这个测试只有在吞吐量测试模式下才能进行。每个线程/进程运行读或写测试。这种分布式读/写测试是基于round robin 模式的。最好使用多于一个线程/进程执行此测试。</div><div class="line"> </div><div class="line">Backwards Read: 测试使用倒序读一个文件的性能。这种读文件方法可能看起来很可笑，事实上，有些应用确实这么干。MSC Nastran是一个使用倒序读文件的应用程序的一个例子。它所读的文件都十分大（大小从G级别到T级别）。尽管许多操作系统使用一些特殊实现来优化顺序读文件的速度，很少有操作系统注意到并增强倒序读文件的性能。</div><div class="line"> </div><div class="line">Record Rewrite: 测试写与覆盖写一个文件中的特定块的性能。这个块可能会发生一些很有趣的事。如果这个块足够小（比CPU数据缓存小），测出来的性能将会非常高。如果比CPU数据缓存大而比TLB小，测出来的是另一个阶段的性能。如果比此二者都大，但比操作系统缓存小，得到的性能又是一个阶段。若大到超过操作系统缓存，又是另一番结果。</div><div class="line"> </div><div class="line">Strided Read: 测试跳跃读一个文件的性能。举例如下：在0偏移量处读4Kbytes，然后间隔200Kbytes,读4Kbytes，再间隔200Kbytes，如此反复。此时的模式是读4Kbytes，间隔200Kbytes并重复这个模式。这又是一个典型的应用行为，文件中使用了数据结构并且访问这个数据结构的特定区域的应用程序常常这样做。</div><div class="line">许多操作系统并没注意到这种行为或者针对这种类型的访问做一些优化。同样，这种访问行为也可能导致一些有趣的性能异常。一个例子是在一个数据片化的文件系统里，应用程序的跳跃导致某一个特定的磁盘成为性能瓶颈。</div><div class="line"> </div><div class="line">Fwrite: 测试调用库函数fwrite()来写文件的性能。这是一个执行缓存与阻塞写操作的库例程。缓存在用户空间之内。如果一个应用程序想要写很小的传输块，fwrite()函数中的缓存与阻塞I/O功能能通过减少实际操作系统调用并在操作系统调用时增加传输块的大小来增强应用程序的性能。</div><div class="line">这个测试是写一个新文件，所以元数据的写入也是要的。</div><div class="line"> </div><div class="line">Frewrite:测试调用库函数fwrite()来写文件的性能。这是一个执行缓存与阻塞写操作的库例程。缓存在用户空间之内。如果一个应用程序想要写很小的传输块，fwrite()函数中的缓存与阻塞I/O功能能通过减少实际操作系统调用并在操作系统调用时增加传输块的大小来增强应用程序的性能。</div><div class="line">这个测试是写入一个已存在的文件，由于无元数据操作，测试的性能会高些。</div><div class="line"> </div><div class="line">Fread:测试调用库函数fread()来读文件的性能。这是一个执行缓存与阻塞读操作的库例程。缓存在用户空间之内。如果一个应用程序想要读很小的传输块，fwrite()函数中的缓存与阻塞I/O功能能通过减少实际操作系统调用并在操作系统调用时增加传输块的大小来增强应用程序的性能。</div><div class="line"> </div><div class="line">Freread: 这个测试与上面的fread 类似，除了在这个测试中被读文件是最近才刚被读过。这将导致更高的性能，因为操作系统缓存了文件数据。</div></pre></td></tr></table></figure>
<p>其它参数说明：<br>-r - 指定一次写入/读出的块大小<br>-s - 指定测试文件的大小<br>-f - filename 指定测试文件的名字,完成后会自动删除(这个文件必须指定你要测试的那个硬盘中)<br>-n 最小文件大小<br>-g 最大文件大小<br>-C 展示每一个线程的输出<br>-t - 线程数 - 有多少个子进程将同时发出I / O请求<br>-F - 文件列表 - 要写/读的文件。 如果不指定，则文件名iozone.DUMMY。*将在默认目录中使用。<br>下面是几个日志记录的参数.好象要输出成图象进行分析，需要指定-a的测试才能输出<br>-R 产生Excel到标准输出<br>-b 指定输出到指定文件上. 比如 -Rb ttt.xls<br>-w  不使用buffer数据<br>-c  不使用buffer数据</p>
<p>安装说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget http://www.iozone.org/src/current/iozone3_465.tar</div><div class="line">tar -xvf iozone3_465.tar</div><div class="line">cd iozone3_465</div><div class="line">make linux</div></pre></td></tr></table></figure>
<p>压测脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">iozone -w -c -e -i 0 -i 1  -i 2 -C -r 4k -s 40g   -t 32 -F /test/f10&#123;0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32&#125;.ioz  -Rb   /root/4k.xls</div><div class="line">sleep  10 </div><div class="line">iozone -w -c -e -i 0 -i 1  -i 2  -C -r 8k -s 40g    -t 8  -F /test/f&#123;10,11,12,13,14,15,16,17,18&#125;.ioz  -Rb   /root/8k.xls</div><div class="line">sleep  10</div><div class="line">iozone -w -c -e -i 0 -i 1  -i 2  -C -r 16k -s 40g   -t 8  -F /test/f&#123;20,21,22,23,24,25,26,27,28&#125;.ioz   -Rb   /root/16k.xls</div><div class="line">sleep  10</div><div class="line">iozone -w -c -e -i 0 -i 1  -i 2 -C -r 32k -s 40g   -t 8  -F /test/f&#123;100,111,112,113,114,115,116,117,118&#125;.ioz   -Rb   /root/32k.xls</div><div class="line">sleep  10</div><div class="line">iozone -w -c -e -i 0 -i 1  -i  2 -C -r 64k -s 40g  -t 8  -F /test/f&#123;210,211,212,213,214,215,216,217,218&#125;.ioz   -Rb   /root/64k.xls</div><div class="line">sleep  10</div><div class="line">iozone -w -c -e -i 0 -i 1  -i  2 -C -r 128k -s 40g  -t 8  -F /test/f&#123;310,311,312,313,314,315,316,317,318&#125;.ioz   -Rb   /root/128k.xls</div><div class="line">sleep  10</div><div class="line">iozone -w -c -e -i 0 -i 1  -i  2 -C -r 512k  -s 40g -t 8  -F /test/f4&#123;10,11,12,13,14,15,16,17,18&#125;.ioz   -Rb   /root/512k.xls</div><div class="line">sleep  10</div><div class="line">iozone -w -c -e -i 0 -i 1  -i  2 -C -r 1024k -s 40g -t 8  -F /test/f5&#123;10,11,12,13,14,15,16,17,18&#125;.ioz   -Rb   /root/1024k.xls</div><div class="line">sleep  10</div><div class="line">iozone -e -i 0 -i 1  -i 2 -C -r 4k -s 20g   -t 8  -F /test/f&#123;0,1,2,3,4,5,6,7,8&#125;.ioz  -Rb   /root/4k.xls</div><div class="line">sleep  10 </div><div class="line">iozone -e -i 0 -i 1  -i 2  -C -r 8k -s 20g    -t 8  -F /test/f&#123;10,11,12,13,14,15,16,17,18&#125;.ioz  -Rb   /root/8k.xls</div><div class="line">sleep  10</div><div class="line">iozone -e -i 0 -i 1  -i 2  -C -r 16k -s 20g   -t 8  -F /test/f&#123;20,21,22,23,24,25,26,27,28&#125;.ioz   -Rb   /root/16k.xls    -Rb   /root/4k.xls</div><div class="line">iozone -w -c -e -i 0 -i 1  -i 2 -C -r 4k -s 40g   -t 20 -F /test/f20&#123;0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20&#125;   -Rb   /root/4k.xls</div></pre></td></tr></table></figure>
<p>在1000M网络环境下，压测结果说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">针对4k bytes的数据在</div><div class="line">Record size = 4 kBytes		</div><div class="line">Output is in kBytes/sec		</div><div class="line">  Initial write 		38216.01245</div><div class="line">        Rewrite 		38227.94891</div><div class="line">           Read 		76362.5874</div><div class="line">        Re-read 		76399.8811</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Zero" />
          <p class="site-author-name" itemprop="name">Zero</p>
          <p class="site-description motion-element" itemprop="description">走过山山水水,脚下高高低低,人生难得糊涂！</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">42</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="392572435" target="_blank" title="QQ">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  QQ
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="392572435@qq.com" target="_blank" title="Mail">
                  
                    <i class="fa fa-fw fa-mail"></i>
                  
                  Mail
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zero</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zerosre"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("DoxG0uQxF81TSYnLX2XSmf3s-gzGzoHsz", "Q4wLV6Vdxd4YnCWesJ0qk9cO");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
